<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DART-Planner: Edge-First Autonomous Navigation Demo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #1a202c; /* Dark background */
        }
        .metric-value { font-size: 1.5rem; font-weight: 700; }
        .metric-label { font-size: 0.875rem; color: #a0aec0; margin-top: 0.25rem; }
    </style>
</head>
<body class="text-gray-200">
    <div class="header bg-gray-900 p-4 border-b border-gray-700">
        <h1 class="text-2xl font-bold text-white">üöÅ DART-Planner Live Demo</h1>
        <div class="subtitle text-gray-400">Production-Ready Edge-First Autonomous Navigation</div>
    </div>

    <!-- Login Section -->
    <div id="login-section" class="container mx-auto p-8 max-w-md">
        <div class="bg-gray-800 p-8 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold mb-6 text-center text-cyan-400">Welcome</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block mb-2 text-sm font-medium">Username</label>
                    <input type="text" id="username" name="username" class="w-full p-2 bg-gray-700 border border-gray-600 rounded" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block mb-2 text-sm font-medium">Password</label>
                    <input type="password" id="password" name="password" class="w-full p-2 bg-gray-700 border border-gray-600 rounded" required>
                </div>
                <button type="submit" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-4 rounded transition duration-300">Login</button>
            </form>
        </div>
    </div>

    <!-- Demo Section (Initially Hidden) -->
    <div id="demo-section" class="main-container hidden p-4">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            
            <!-- Left Column: Visualization and Metrics -->
            <div class="lg:col-span-2 space-y-4">
                <div class="visualization-panel bg-gray-800 p-4 rounded-lg shadow-inner relative">
                    <div id="connection-status-badge" class="status-badge absolute top-4 right-4 px-3 py-1 text-sm font-bold text-white rounded-full bg-yellow-600">CONNECTING...</div>
                    <div id="visualization" class="w-full h-96 lg:h-[60vh] bg-black rounded"></div>
                </div>
                <div class="metrics-grid grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="metric-card bg-gray-800 p-4 rounded-lg text-center">
                        <div id="planning-time" class="metric-value text-white">0.0</div>
                        <div class="metric-label">Planning Time (ms)</div>
                    </div>
                    <div class="metric-card bg-gray-800 p-4 rounded-lg text-center">
                        <div id="mapping-rate" class="metric-value text-white">0</div>
                        <div class="metric-label">Mapping Queries/sec</div>
                    </div>
                    <div class="metric-card bg-gray-800 p-4 rounded-lg text-center">
                        <div id="autonomous-time" class="metric-value text-white">0</div>
                        <div class="metric-label">Autonomous Time (s)</div>
                    </div>
                    <div class="metric-card bg-gray-800 p-4 rounded-lg text-center">
                        <div id="neural-dependency" class="metric-value text-white">N/A</div>
                        <div class="metric-label">Neural Dependency</div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Controls -->
            <div class="lg:col-span-1 space-y-4">
                <div class="bg-gray-800 p-6 rounded-lg shadow-inner">
                    <h2 class="text-xl font-bold mb-4 text-cyan-400">Control Panel</h2>
                    <div class="flex items-center justify-between mb-4">
                        <span id="user-info-badge" class="px-3 py-1 text-sm font-bold text-white rounded-full bg-gray-600">NOT LOGGED IN</span>
                        <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition duration-300">Logout</button>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <button id="start-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition duration-300" disabled>Start Demo</button>
                        <button id="stop-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition duration-300" disabled>Stop Demo</button>
                    </div>
                </div>

                <div id="waypoint-management" class="bg-gray-800 p-6 rounded-lg shadow-inner">
                    <h2 class="text-xl font-bold mb-4 text-cyan-400">Mission Planning</h2>
                    <p class="text-sm text-gray-400 mb-4">Click inside the visualization pane to add waypoints.</p>
                    <div id="waypoint-list" class="mt-4 text-sm">Waypoints: <span id="waypoint-count">0</span></div>
                    <div class="grid grid-cols-2 gap-4 mt-4">
                      <button id="send-mission-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition duration-300" disabled>Send Mission</button>
                      <button id="clear-mission-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded transition duration-300" disabled>Clear</button>
                    </div>
                </div>

                <div id="admin-panel" class="hidden bg-gray-800 p-6 rounded-lg shadow-inner">
                    <h2 class="text-xl font-bold mb-4 text-cyan-400">Admin Panel</h2>
                    <form id="create-user-form" class="space-y-4">
                        <h3 class="text-lg font-semibold">Create New User</h3>
                        <input type="text" id="new-username" placeholder="Username" class="w-full p-2 bg-gray-700 border-gray-600 rounded">
                        <input type="password" id="new-password" placeholder="Password" class="w-full p-2 bg-gray-700 border-gray-600 rounded">
                        <select id="new-user-role" class="w-full p-2 bg-gray-700 border-gray-600 rounded"></select>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Create User</button>
                    </form>
                    <div class="mt-6">
                        <h3 class="text-lg font-semibold mb-2">Manage Users</h3>
                        <table class="min-w-full bg-gray-900 rounded-lg">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium uppercase">Username</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium uppercase">Role</th>
                                    <th class="px-4 py-2 text-center text-xs font-medium uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="user-list-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const sio = io({
                autoConnect: false, // Don't connect automatically
                transports: ['websocket'], // Prefer WebSocket
            });

            // --- UI Elements ---
            const loginSection = document.getElementById('login-section');
            const demoSection = document.getElementById('demo-section');
            const adminPanel = document.getElementById('admin-panel');
            
            const loginForm = document.getElementById('login-form');
            const logoutButton = document.getElementById('logout-btn');

            const connectionStatusBadge = document.getElementById('connection-status-badge');
            const userInfoBadge = document.getElementById('user-info-badge');
            
            const planningTime = document.getElementById('planning-time');
            const mappingRate = document.getElementById('mapping-rate');
            const autonomousTime = document.getElementById('autonomous-time');

            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');

            let waypoints = [];
            let currentUser = null;

            // --- CSRF Handling ---
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            // --- API Helper ---
            async function apiRequest(endpoint, options = {}) {
                options.headers = {
                    'Content-Type': 'application/json',
                    ...options.headers,
                };
                
                // For non-GET requests, we add the CSRF token from the cookie
                if (options.method && !['GET', 'HEAD', 'OPTIONS'].includes(options.method.toUpperCase())) {
                    const csrfToken = getCookie('csrftoken');
                    if(csrfToken) options.headers['X-CSRF-Token'] = csrfToken;
                }
                
                const response = await fetch(endpoint, options);
                if (!response.ok) {
                    const error = await response.json().catch(() => ({ detail: 'Request failed with status ' + response.status }));
                    throw new Error(error.detail || 'API request failed');
                }
                // Handle responses with no content
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    return response.json();
                } else {
                    return; 
                }
            }


            // --- Authentication ---
            async function checkLoginStatus() {
                try {
                    const user = await apiRequest('/api/me');
                    currentUser = user;
                    showDemoUI(user);
                    sio.auth = { token: getCookie('access_token_cookie') }; // Example, adjust as needed
                    sio.connect();
                } catch (error) {
                    showLoginUI();
                }
            }

            function showLoginUI() {
                loginSection.classList.remove('hidden');
                demoSection.classList.add('hidden');
                adminPanel.classList.add('hidden');
            }

            function showDemoUI(user) {
                loginSection.classList.add('hidden');
                demoSection.classList.remove('hidden');

                userInfoBadge.textContent = `${user.username} (${user.role})`;
                startBtn.disabled = false;
                stopBtn.disabled = false;
                
                if (user.role === 'ADMIN') {
                    adminPanel.classList.remove('hidden');
                    loadAdminPanel();
                } else {
                    adminPanel.classList.add('hidden');
                }
            }

            if(loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const username = loginForm.username.value;
                    const password = loginForm.password.value;
                    try {
                        await apiRequest('/api/login', {
                            method: 'POST',
                            body: JSON.stringify({ username, password })
                        });
                        await checkLoginStatus();
                    } catch (error) {
                        alert(`Login failed: ${error.message}`);
                    }
                });
            }

            if(logoutButton) {
                logoutButton.addEventListener('click', async () => {
                    try {
                        await apiRequest('/api/logout', { method: 'POST' });
                        sio.disconnect();
                        currentUser = null;
                        showLoginUI();
                    } catch (error) {
                        alert(`Logout failed: ${error.message}`);
                    }
                });
            }


            // --- Admin Panel ---
            async function loadAdminPanel() {
                const userListBody = document.getElementById('user-list-body');
                const roleSelect = document.getElementById('new-user-role');
                try {
                    const [users, roles] = await Promise.all([
                        apiRequest('/api/admin/users'),
                        apiRequest('/api/admin/roles')
                    ]);

                    // Populate roles
                    roleSelect.innerHTML = roles.map(r => `<option value="${r}">${r}</option>`).join('');

                    // Populate users
                    userListBody.innerHTML = users.map(u => `
                        <tr class="border-b border-gray-700">
                            <td class="px-4 py-2">${u.username}</td>
                            <td class="px-4 py-2">${u.role}</td>
                            <td class="px-4 py-2 text-center">
                                <button class="text-red-500 hover:text-red-700 delete-user" data-id="${u.id}">Delete</button>
                            </td>
                        </tr>
                    `).join('');

                    // Add event listeners for delete buttons
                    document.querySelectorAll('.delete-user').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            const userId = e.target.dataset.id;
                            if (confirm(`Are you sure you want to delete this user?`)) {
                                try {
                                    await apiRequest(`/api/admin/users/${userId}`, { method: 'DELETE' });
                                    alert('User deleted successfully!');
                                    await loadAdminPanel(); // Refresh user list
                                } catch (err) {
                                    alert(`Error deleting user: ${err.message}`);
                                }
                            }
                        });
                    });

                } catch (error) {
                    console.error('Failed to load admin data:', error);
                    adminPanel.innerHTML = '<p class="text-red-500">Failed to load admin data.</p>';
                }
            }
            
            const createUserForm = document.getElementById('create-user-form');
            if(createUserForm){
                 createUserForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const username = document.getElementById('new-username').value;
                    const password = document.getElementById('new-password').value;
                    const role = document.getElementById('new-user-role').value;
                    try {
                        await apiRequest('/api/admin/users', {
                            method: 'POST',
                            body: JSON.stringify({ username, password, role })
                        });
                        document.getElementById('new-username').value = '';
                        document.getElementById('new-password').value = '';
                        await loadAdminPanel();
                        alert('User created successfully!');
                    } catch (err) {
                        alert(`Error creating user: ${err.message}`);
                    }
                });
            }

            // --- WebSocket Handlers ---
            sio.on('connect', () => {
                connectionStatusBadge.textContent = 'CONNECTED';
                connectionStatusBadge.classList.remove('bg-yellow-600');
                connectionStatusBadge.classList.add('bg-green-600');
            });

            sio.on('disconnect', () => {
                connectionStatusBadge.textContent = 'DISCONNECTED';
                connectionStatusBadge.classList.remove('bg-green-600');
                connectionStatusBadge.classList.add('bg-yellow-600');
            });
            
            sio.on('telemetry', (data) => {
                if (data.performance) {
                    planningTime.textContent = data.performance.avg_planning_time_ms.toFixed(1);
                    mappingRate.textContent = data.performance.mapping_queries_per_sec || 0;
                    autonomousTime.textContent = data.performance.autonomous_operation_time_s || 0;
                }
                 // Update THREE.js scene if drone state is present
                if (data.drone_state && droneMesh) {
                    droneMesh.position.set(data.drone_state.position.x, data.drone_state.position.z, data.drone_state.position.y);
                    // Note: Y and Z are swapped for THREE.js coordinate system (Y is up)
                }
            });

            // --- Mission/Waypoint Controls ---
            const sendMissionBtn = document.getElementById('send-mission-btn');
            const clearMissionBtn = document.getElementById('clear-mission-btn');
            const waypointCountSpan = document.getElementById('waypoint-count');
            
            // --- THREE.js Visualization ---
            const vizContainer = document.getElementById('visualization');
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a202c); // Match body bg
            const camera = new THREE.PerspectiveCamera(75, vizContainer.clientWidth / vizContainer.clientHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(vizContainer.clientWidth, vizContainer.clientHeight);
            vizContainer.appendChild(renderer.domElement);

            camera.position.set(0, 10, 15);
            camera.lookAt(0, 0, 0);
            
            // Add a grid helper
            const gridHelper = new THREE.GridHelper(50, 50, 0x444444, 0x444444);
            scene.add(gridHelper);

            // Add a drone mesh
            const droneGeometry = new THREE.ConeGeometry(0.5, 1, 4);
            const droneMaterial = new THREE.MeshBasicMaterial({ color: 0x00ffff });
            const droneMesh = new THREE.Mesh(droneGeometry, droneMaterial);
            scene.add(droneMesh);

            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2();
            const plane = new THREE.Plane(new THREE.Vector3(0, 1, 0), 0); // Ground plane at Y=0

            function onWindowResize() {
                camera.aspect = vizContainer.clientWidth / vizContainer.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(vizContainer.clientWidth, vizContainer.clientHeight);
            }
            window.addEventListener('resize', onWindowResize);

            function onClick(event) {
                const rect = renderer.domElement.getBoundingClientRect();
                mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
                raycaster.setFromCamera(mouse, camera);
                
                const intersectPoint = new THREE.Vector3();
                raycaster.ray.intersectPlane(plane, intersectPoint);

                if (intersectPoint) {
                    addWaypoint(intersectPoint);
                }
            }
            renderer.domElement.addEventListener('click', onClick);
            
            let waypointMeshes = [];
            function addWaypoint(pt) {
                const sphere = new THREE.Mesh(new THREE.SphereGeometry(0.2, 16, 16), new THREE.MeshBasicMaterial({ color: 0xff00ff }));
                sphere.position.copy(pt);
                scene.add(sphere);
                waypointMeshes.push(sphere);
                waypoints.push({ x: pt.x, y: pt.z, z: pt.y }); // Swap Z and Y for backend
                updateWaypointUI();
            }

            function updateWaypointUI() {
                waypointCountSpan.textContent = waypoints.length;
                sendMissionBtn.disabled = waypoints.length === 0;
                clearMissionBtn.disabled = waypoints.length === 0;
            }

            sendMissionBtn.addEventListener('click', async () => {
                if (!currentUser || waypoints.length === 0) return;
                try {
                    await apiRequest('/api/mission', {
                        method: 'POST',
                        body: JSON.stringify({ waypoints })
                    });
                    alert('Mission uploaded successfully!');
                    clearWaypoints();
                } catch(err) {
                    alert(`Error uploading mission: ${err.message}`);
                }
            });

            clearMissionBtn.addEventListener('click', clearWaypoints);

            function clearWaypoints() {
                waypoints = [];
                waypointMeshes.forEach(mesh => scene.remove(mesh));
                waypointMeshes = [];
                updateWaypointUI();
            }

            function animate() {
                requestAnimationFrame(animate);
                renderer.render(scene, camera);
            }
            animate();
            
            // Initial Check
            checkLoginStatus();
        });
    </script>
</body>
</html>
